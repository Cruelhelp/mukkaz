<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdn.quilljs.com https://pl28394065.effectivegatecpm.com https://pl28394078.effectivegatecpm.com https://va.vercel-scripts.com https://cdn.growthbook.io; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.quilljs.com; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data: https: blob:; media-src 'self' blob: https: https://videodelivery.net https://cloudflarestream.com; connect-src 'self' https://*.supabase.co https://api.cloudflare.com https://videodelivery.net https://www.effectivegatecpm.com https://vitals.vercel-insights.com https://cdn.growthbook.io; frame-src 'self' https://embed.cloudflarestream.com; object-src 'none'; base-uri 'self';">
  <title>Video Editor - Mukkaz</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="config.local.js" onerror="console.warn('config.local.js not found - using defaults')"></script>
  <script src="config.js"></script>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="youtube-redesign.css">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="age-gate.js"></script>
  <script src="components.js"></script>
  <script src="analytics.js"></script>
  <script src="growthbook.js"></script>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-left">
      <button class="nav-icon hamburger-btn" id="hamburgerBtn">
        <span id="hamburgerIcon"></span>
      </button>
      <a href="index.html" class="logo">
        <img src="logo.png" alt="Mukkaz" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="navbar-center">
      <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Search videos..." autocomplete="off">
        <button class="search-btn" id="searchBtn">
          <span id="searchIcon"></span>
        </button>
        <div class="search-suggestions hidden" id="searchSuggestions"></div>
      </div>
    </div>

    <div class="navbar-right" id="navbarRight">
      <div class="navbar-skeleton" id="navbarSkeleton">
        <div class="skeleton-nav-icon"></div>
        <div class="skeleton-nav-icon"></div>
        <div class="skeleton-avatar"></div>
      </div>
    </div>
  </nav>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-section">
      <a href="index.html" class="sidebar-item">
        <span id="homeIcon"></span>
        <span>Home</span>
      </a>
    </div>
    <div class="sidebar-section">
      <a href="my-videos.html" class="sidebar-item active">
        <span id="libraryIcon"></span>
        <span>My Videos</span>
      </a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="editor-container">
      <!-- Header -->
      <div class="editor-header">
        <h1>Video Editor</h1>
        <div class="editor-header-actions">
          <button class="btn-secondary" id="cancelBtn">Cancel</button>
          <button class="btn-primary" id="saveBtn">Save Changes</button>
        </div>
      </div>

      <!-- Two Column Layout -->
      <div class="editor-layout">
        <!-- Left Column - Video Details -->
        <div class="editor-main">
          <!-- Video Preview -->
          <div class="editor-section">
            <h3 class="editor-section-title">Video Preview</h3>
            <div class="editor-video-preview" id="videoPreview">
              <div class="editor-thumbnail-wrapper">
                <img src="" alt="Video thumbnail" id="thumbnailPreview" class="editor-thumbnail">
                <span id="videoDuration" class="video-duration"></span>
              </div>
            </div>
          </div>

          <!-- Title -->
          <div class="editor-section">
            <label class="form-label">Title *</label>
            <input type="text" id="videoTitle" class="form-input" maxlength="100" required>
            <span class="char-count"><span id="titleCharCount">0</span>/100</span>
          </div>

          <!-- Description -->
          <div class="editor-section">
            <label class="form-label">Description</label>
            <div id="videoDescriptionEditor" style="background: var(--bg-secondary); border-radius: 8px; min-height: 150px;"></div>
            <span class="char-count"><span id="descCharCount">0</span>/500</span>
          </div>

          <!-- Thumbnail -->
          <div class="editor-section">
            <label class="form-label">Thumbnail</label>
            <div class="editor-thumbnail-upload">
              <input type="file" id="thumbnailInput" accept="image/*" style="display: none;">
              <button class="btn-secondary" onclick="document.getElementById('thumbnailInput').click()">
                <span id="uploadThumbnailIcon"></span>
                Change Thumbnail
              </button>
              <p class="form-hint">Recommended: 1280x720px (16:9 aspect ratio)</p>
            </div>
          </div>

          <!-- Tags -->
          <div class="editor-section">
            <label class="form-label">Tags</label>
            <div class="tags-container">
              <div class="predefined-tags" id="predefinedTags">
                <label class="tag-checkbox">
                  <input type="checkbox" name="tags" value="gaming"> Gaming
                </label>
                <label class="tag-checkbox">
                  <input type="checkbox" name="tags" value="music"> Music
                </label>
                <label class="tag-checkbox">
                  <input type="checkbox" name="tags" value="sports"> Sports
                </label>
                <label class="tag-checkbox">
                  <input type="checkbox" name="tags" value="news"> News
                </label>
                <label class="tag-checkbox">
                  <input type="checkbox" name="tags" value="education"> Education
                </label>
                <label class="tag-checkbox">
                  <input type="checkbox" name="tags" value="entertainment"> Entertainment
                </label>
                <label class="tag-checkbox">
                  <input type="checkbox" name="tags" value="comedy"> Comedy
                </label>
                <label class="tag-checkbox">
                  <input type="checkbox" name="tags" value="technology"> Technology
                </label>
              </div>
            </div>

            <!-- Custom Tags -->
            <div class="custom-tags-section">
              <div class="custom-tags-input">
                <input type="text" id="customTagInput" class="form-input" placeholder="Add custom tag...">
                <button type="button" class="btn-primary" id="addCustomTagBtn">Add</button>
              </div>
              <div id="customTagsList" class="custom-tags-list"></div>
            </div>
          </div>
        </div>

        <!-- Right Column - Video Info & Danger Zone -->
        <div class="editor-sidebar">
          <!-- Video Statistics -->
          <div class="editor-card">
            <h3 class="editor-card-title">Statistics</h3>
            <div class="editor-stats">
              <div class="editor-stat">
                <span class="editor-stat-label">Views</span>
                <span class="editor-stat-value" id="statViews">0</span>
              </div>
              <div class="editor-stat">
                <span class="editor-stat-label">Likes</span>
                <span class="editor-stat-value" id="statLikes">0</span>
              </div>
              <div class="editor-stat">
                <span class="editor-stat-label">Comments</span>
                <span class="editor-stat-value" id="statComments">0</span>
              </div>
              <div class="editor-stat">
                <span class="editor-stat-label">Uploaded</span>
                <span class="editor-stat-value" id="statUploaded">-</span>
              </div>
            </div>
          </div>

          <!-- Video URL -->
          <div class="editor-card">
            <h3 class="editor-card-title">Video URL</h3>
            <div class="editor-url-box">
              <input type="text" id="videoUrl" class="form-input" readonly>
              <button class="btn-secondary" id="copyUrlBtn">
                <span id="copyIcon"></span>
                Copy
              </button>
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="editor-card editor-danger-zone">
            <h3 class="editor-card-title">Danger Zone</h3>
            <p class="editor-danger-text">Once you delete a video, there is no going back. Please be certain.</p>
            <button class="btn-danger" id="deleteVideoBtn">
              <span id="deleteIcon"></span>
              Delete Video
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="icons.js"></script>
  <script src="utils.js"></script>
  <script src="supabase.js"></script>
  <script src="app.js"></script>
  <script>
    let currentVideo = null;
    let quillEditor = null;
    let customTags = [];
    let newThumbnailFile = null;

    document.addEventListener('DOMContentLoaded', async () => {
      await initializeApp();

      // Load icons
      document.getElementById('uploadThumbnailIcon').innerHTML = getIcon('upload');
      document.getElementById('copyIcon').innerHTML = getIcon('copy');
      document.getElementById('deleteIcon').innerHTML = getIcon('delete');

      // Check if user is logged in
      const user = await getCurrentUser();
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      // Get video ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const videoId = urlParams.get('v');

      if (!videoId) {
        showNotification('No video specified', 'error');
        window.location.href = 'my-videos.html';
        return;
      }

      setupEditor();
      await loadVideo(videoId);
      setupEventListeners();
    });

    function setupEditor() {
      // Rich text editor
      quillEditor = new Quill('#videoDescriptionEditor', {
        theme: 'snow',
        placeholder: '',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            ['link'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['clean']
          ]
        }
      });

      quillEditor.on('text-change', function() {
        const text = quillEditor.getText();
        const length = text.trim().length;
        document.getElementById('descCharCount').textContent = Math.min(length, 500);

        if (length > 500) {
          quillEditor.deleteText(500, length);
        }
      });

      // Title character count
      document.getElementById('videoTitle').addEventListener('input', (e) => {
        document.getElementById('titleCharCount').textContent = e.target.value.length;
      });
    }

    async function loadVideo(videoId) {
      try {
        const video = await getVideo(videoId);
        const user = await getCurrentUser();

        // Check if user owns this video
        if (video.user_id !== user.id) {
          showNotification('You do not have permission to edit this video', 'error');
          window.location.href = 'my-videos.html';
          return;
        }

        currentVideo = video;

        // Populate form
        document.getElementById('videoTitle').value = video.title;
        document.getElementById('titleCharCount').textContent = video.title.length;

        if (video.description) {
          quillEditor.root.innerHTML = video.description;
        }

        if (video.thumbnail_url) {
          document.getElementById('thumbnailPreview').src = video.thumbnail_url;
        }

        if (video.duration) {
          document.getElementById('videoDuration').textContent = video.duration;
        }

        // Tags
        if (video.tags) {
          const tagsArray = typeof video.tags === 'string'
            ? video.tags.split(',').map(t => t.trim())
            : video.tags;

          // Check predefined tags
          tagsArray.forEach(tag => {
            const checkbox = document.querySelector(`input[name="tags"][value="${tag}"]`);
            if (checkbox) {
              checkbox.checked = true;
            } else {
              // Add as custom tag
              customTags.push(tag);
              addCustomTagChip(tag);
            }
          });
        }

        // Statistics
        document.getElementById('statViews').textContent = formatNumber(video.views_count || 0);
        document.getElementById('statComments').textContent = formatNumber(video.comments?.length || 0);
        document.getElementById('statUploaded').textContent = timeSince(new Date(video.created_at)) + ' ago';

        // Get likes count
        const { likes } = await getVoteCounts(videoId);
        document.getElementById('statLikes').textContent = formatNumber(likes);

        // Video URL
        const videoUrl = `${window.location.origin}/watch.html?v=${videoId}`;
        document.getElementById('videoUrl').value = videoUrl;

      } catch (error) {
        console.error('Error loading video:', error);
        showNotification('Error loading video', 'error');
      }
    }

    function setupEventListeners() {
      // Save button
      document.getElementById('saveBtn').addEventListener('click', saveChanges);

      // Cancel button
      document.getElementById('cancelBtn').addEventListener('click', () => {
        window.location.href = 'my-videos.html';
      });

      // Copy URL
      document.getElementById('copyUrlBtn').addEventListener('click', async () => {
        const url = document.getElementById('videoUrl').value;
        try {
          await navigator.clipboard.writeText(url);
          showNotification('URL copied to clipboard!', 'success');
        } catch (error) {
          showNotification('Failed to copy URL', 'error');
        }
      });

      // Delete video
      document.getElementById('deleteVideoBtn').addEventListener('click', deleteVideo);

      // Thumbnail upload
      document.getElementById('thumbnailInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          newThumbnailFile = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById('thumbnailPreview').src = e.target.result;
          };
          reader.readAsDataURL(file);
          showNotification('Thumbnail will be updated when you save', 'info');
        }
      });

      // Custom tags
      document.getElementById('addCustomTagBtn').addEventListener('click', addCustomTag);
      document.getElementById('customTagInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addCustomTag();
        }
      });
    }

    function addCustomTag() {
      const input = document.getElementById('customTagInput');
      const tagValue = input.value.trim();
      if (!tagValue) return;

      const tagKey = tagValue.toLowerCase().replace(/\s+/g, '_');

      if (customTags.includes(tagKey)) {
        showNotification('Tag already added', 'warning');
        return;
      }

      customTags.push(tagKey);
      addCustomTagChip(tagKey);
      input.value = '';
    }

    function addCustomTagChip(tag) {
      const tagChip = document.createElement('div');
      tagChip.className = 'custom-tag-chip';
      tagChip.innerHTML = `
        <span>${tag.replace(/_/g, ' ')}</span>
        <button type="button" class="remove-tag-btn" onclick="removeCustomTag('${tag}')">Ã—</button>
      `;
      document.getElementById('customTagsList').appendChild(tagChip);
    }

    function removeCustomTag(tag) {
      customTags = customTags.filter(t => t !== tag);
      const chips = document.getElementById('customTagsList').children;
      for (let chip of chips) {
        if (chip.textContent.includes(tag.replace(/_/g, ' '))) {
          chip.remove();
          break;
        }
      }
    }

    async function saveChanges() {
      try {
        const title = document.getElementById('videoTitle').value.trim();
        if (!title) {
          showNotification('Title is required', 'error');
          return;
        }

        showNotification('Saving changes...', 'info');

        const description = quillEditor.root.innerHTML;
        const selectedTags = Array.from(document.querySelectorAll('input[name="tags"]:checked'))
          .map(cb => cb.value);
        const allTags = [...selectedTags, ...customTags];

        const updates = {
          title,
          description,
          tags: allTags.join(',')
        };

        // Upload new thumbnail if selected
        if (newThumbnailFile) {
          const thumbnailPath = `thumbnails/${currentVideo.id}_${Date.now()}.${newThumbnailFile.name.split('.').pop()}`;
          const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('videos')
            .upload(thumbnailPath, newThumbnailFile);

          if (uploadError) throw uploadError;

          const { data: urlData } = supabaseClient.storage
            .from('videos')
            .getPublicUrl(thumbnailPath);

          updates.thumbnail_url = urlData.publicUrl;
        }

        // Update video
        const { error } = await supabaseClient
          .from('videos')
          .update(updates)
          .eq('id', currentVideo.id);

        if (error) throw error;

        showNotification('Changes saved successfully!', 'success');
        setTimeout(() => {
          window.location.href = 'my-videos.html';
        }, 1500);

      } catch (error) {
        console.error('Error saving changes:', error);
        showNotification('Error saving changes: ' + error.message, 'error');
      }
    }

    async function deleteVideo() {
      if (!confirm('Are you sure you want to delete this video? This action cannot be undone.')) {
        return;
      }

      if (!confirm('This will permanently delete the video and all its data (comments, likes, etc.). Are you absolutely sure?')) {
        return;
      }

      try {
        showNotification('Deleting video...', 'info');

        // Delete all related records first
        await supabaseClient.from('video_votes').delete().eq('video_id', currentVideo.id);
        await supabaseClient.from('comments').delete().eq('video_id', currentVideo.id);
        await supabaseClient.from('watch_history').delete().eq('video_id', currentVideo.id);
        await supabaseClient.from('bookmarks').delete().eq('video_id', currentVideo.id);
        await supabaseClient.from('notifications').delete().eq('video_id', currentVideo.id);

        // Delete the video
        const { error } = await supabaseClient
          .from('videos')
          .delete()
          .eq('id', currentVideo.id);

        if (error) throw error;

        showNotification('Video deleted successfully', 'success');
        setTimeout(() => {
          window.location.href = 'my-videos.html';
        }, 1500);

      } catch (error) {
        console.error('Error deleting video:', error);
        showNotification('Error deleting video: ' + error.message, 'error');
      }
    }

    // Make removeCustomTag global
    window.removeCustomTag = removeCustomTag;
  </script>

  <!-- Ads removed -->
</body>
</html>
