<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://vjs.zencdn.net https://cdn.quilljs.com https://pl28394065.effectivegatecpm.com https://pl28394078.effectivegatecpm.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://vjs.zencdn.net https://unpkg.com https://cdn.quilljs.com; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data: https: blob:; media-src 'self' blob: https: https://videodelivery.net; connect-src 'self' https://*.supabase.co https://cdn.jsdelivr.net https://unpkg.com https://api.cloudflare.com https://videodelivery.net https://embed.cloudflarestream.com; frame-src 'self' https://embed.cloudflarestream.com https://iframe.videodelivery.net; worker-src 'self' blob:; child-src 'self' blob:; object-src 'none'; base-uri 'self';">
  <title>Upload Video - Mukkaz</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="config.local.js" onerror="console.warn('config.local.js not found - using defaults')"></script>
  <script src="config.js"></script>
  <script src="config.cloudflare.js"></script>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="youtube-redesign.css">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="age-gate.js"></script>
  <script src="components.js"></script>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-left">
      <button class="nav-icon hamburger-btn" id="hamburgerBtn">
        <span id="hamburgerIcon"></span>
      </button>
      <a href="index.html" class="logo">
        <img src="logo.png" alt="Mukkaz" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="navbar-center">
      <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Search videos..." autocomplete="off">
        <button class="search-btn" id="searchBtn">
          <span id="searchIcon"></span>
        </button>
        <div class="search-suggestions hidden" id="searchSuggestions"></div>
      </div>
    </div>

    <div class="navbar-right" id="navbarRight">
      <div class="navbar-skeleton" id="navbarSkeleton">
        <div class="skeleton-nav-icon"></div>
        <div class="skeleton-nav-icon"></div>
        <div class="skeleton-avatar"></div>
      </div>
    </div>
  </nav>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <!-- Home Section -->
    <div class="sidebar-section">
      <a href="index.html" class="sidebar-item">
        <span id="homeIcon"></span>
        <span>Home</span>
      </a>
    </div>

    <!-- Trending Section -->
    <div class="sidebar-section">
      <a href="index.html#trending" class="sidebar-item">
        <span id="trendingIcon"></span>
        <span>Trending</span>
      </a>
    </div>

    <!-- Subscriptions Section -->
    <div class="sidebar-section" id="subscriptionsSidebarSection">
      <div class="sidebar-section-header">
        <span id="subscriptionsIcon"></span>
        <span>Subscriptions</span>
      </div>
      <div id="subscriptionsList">
        <!-- Subscriptions loaded by JavaScript -->
      </div>
    </div>

    <!-- History Section -->
    <div class="sidebar-section">
      <a href="index.html#history" class="sidebar-item">
        <span id="historyIcon"></span>
        <span>History</span>
      </a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="upload-container">
      <h2 class="page-title">Upload Video</h2>

      <form id="uploadForm" class="simple-upload-form">
        <!-- LEFT COLUMN: Video Preview -->
        <div class="upload-left-column">
          <div class="form-section">
            <h3>Video Preview</h3>
            <div class="file-upload-area" id="videoUploadArea" style="min-height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(204,0,0,0.05) 0%, rgba(0,0,0,0.1) 100%); border: 2px dashed rgba(255,255,255,0.2);">
              <div id="videoUploadIcon" style="font-size: 4rem; color: var(--text-secondary); margin-bottom: 1rem;"></div>
              <p style="font-size: 1.2rem; margin: 0.5rem 0; font-weight: 500;">Drag & Drop Your Video Here</p>
              <p class="secondary" style="margin-bottom: 1.5rem;">or click to browse</p>
              <button type="button" class="btn-secondary" onclick="document.getElementById('videoFile').click()" style="padding: 0.75rem 2rem;">
                Select File
              </button>
              <p class="secondary" style="margin-top: 1rem; font-size: 0.85rem;">Any size accepted • Auto-compressed for web</p>
              <input type="file" id="videoFile" class="file-input" accept="video/*" required>
            </div>

            <!-- Video Preview (shown after upload) -->
            <div id="videoPreviewSection" class="hidden" style="margin-top: 1.5rem;">
              <div class="video-preview-container">
                <video id="videoPreview" controls></video>
              </div>

              <!-- Video Info -->
              <div class="info-grid" style="margin-top: 1rem;">
                <div class="info-item">
                  <span class="info-label">Duration:</span>
                  <span id="videoDuration">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Resolution:</span>
                  <span id="videoResolution">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Quality:</span>
                  <span id="detectedQuality" style="color: var(--accent-red); font-weight: 700;">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Original Size:</span>
                  <span id="originalSize">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Final Size:</span>
                  <span id="finalSize" style="color: var(--accent-red); font-weight: 700;">-</span>
                </div>
              </div>

              <!-- Compression Status -->
              <div id="compressionStatus" class="alert alert-info hidden" style="margin-top: 1rem;">
                <strong>Auto-compressing...</strong> Optimizing your video for web playback
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN: Controls and Fields -->
        <div class="upload-right-column">
          <!-- Thumbnails -->
          <div id="thumbnailSection" class="form-section">
            <h3>Select Thumbnail</h3>
            <div class="thumbnails-grid" id="thumbnailsGrid">
              <!-- Auto-generated thumbnails -->
            </div>
            <div style="margin-top: 1rem;">
              <label class="btn-secondary" for="customThumbnailInput" style="cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                <span id="thumbnailUploadIcon"></span> Upload Custom Thumbnail
              </label>
              <input type="file" id="customThumbnailInput" class="file-input" accept="image/*">
            </div>
          </div>

          <!-- Video Details -->
          <div id="detailsSection" class="form-section">
            <h3>Video Details</h3>

            <div class="form-group">
              <label class="form-label">Title *</label>
              <input type="text" id="videoTitle" class="form-input" maxlength="100" placeholder="Enter video title..." required>
              <span class="char-count"><span id="titleCharCount">0</span>/100</span>
            </div>

            <div class="form-group">
              <label class="form-label">Description</label>
              <div id="videoDescriptionEditor" style="background: var(--bg-secondary); border-radius: 8px; min-height: 150px;"></div>
              <textarea id="videoDescription" style="display: none;"></textarea>
              <span class="char-count"><span id="descCharCount">0</span>/500</span>
            </div>

            <div class="form-group">
              <label class="form-label">Tags * (Select all that apply)</label>
              <div class="tags-container">
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="big_batty"><span>Big Batty</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="phat_pussy"><span>Phat Pussy</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="backshot"><span>Backshot</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="hood_gyal"><span>Hood Gyal</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="tight_pussy"><span>Tight Pussy</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="kingston"><span>Kingston</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="st_andrew"><span>St. Andrew</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="st_catherine"><span>St. Catherine</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="portmore"><span>Portmore</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="spanish_town"><span>Spanish Town</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="montego_bay"><span>Montego Bay</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="mandeville"><span>Mandeville</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="ocho_rios"><span>Ocho Rios</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="bumper"><span>Bumper</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="cocky"><span>Cocky</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="fuck"><span>Fuck</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="breed"><span>Breed</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="suck"><span>Suck</span></label>
                <label class="tag-checkbox"><input type="checkbox" name="tags" value="badman"><span>Badman</span></label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Custom Tags (Optional)</label>
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="text" id="customTagInput" class="form-input" placeholder="Add custom tag (e.g. Kingston Vibes)" style="flex: 1;">
                <button type="button" class="btn-secondary" id="addCustomTagBtn" style="padding: 0 20px;">Add Tag</button>
              </div>
              <div id="customTagsList" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 30px;">
                <!-- Custom tags will appear here -->
              </div>
              <p class="secondary" style="font-size: 12px; margin-top: 6px;">Custom tags help viewers find your content. Separate words with spaces.</p>
            </div>
          </div>

          <!-- Upload Progress -->
          <div id="uploadProgressSection" class="upload-progress-container hidden">
            <h4 id="uploadStatusText">Processing video...</h4>
            <div class="progress-bar">
              <div class="progress-fill" id="uploadProgressBar"></div>
            </div>
            <p id="uploadProgressText">0%</p>
          </div>

          <!-- Submit Button -->
          <div id="submitSection" class="form-section" style="text-align: center;">
            <button type="submit" class="btn-primary" id="uploadSubmitBtn" disabled style="padding: 1rem 4rem; font-size: 1.1rem; opacity: 0.5; cursor: not-allowed; display: inline-flex; align-items: center; gap: 10px; height: auto;">
              <span id="uploadIcon"></span> Upload to Mukkaz
            </button>
            <p class="secondary" style="margin-top: 0.5rem; font-size: 0.85rem;">Select a video file to continue</p>
          </div>
        </div>
      </form>
    </div>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.js"></script>
  <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="icons.js"></script>
  <script src="utils.js"></script>
  <script src="supabase.js"></script>
  <script src="cloudflare-stream.js"></script>
  <script src="app.js"></script>

  <script>
    // Upload State
    let uploadState = {
      originalFile: null,
      processedFile: null,
      thumbnails: [],
      selectedThumbnail: null,
      customThumbnail: null,
      metadata: {
        duration: 0,
        width: 0,
        height: 0,
        quality: 'HD',
        needsCompression: false
      },
      ffmpeg: null,
      ffmpegLoaded: false
    };

    let quillEditor = null;

    document.addEventListener('DOMContentLoaded', async () => {
      await initializeApp();
      setupRichTextEditor();
      setupUploadHandlers();
      loadUploadIcons();
    });

    function loadUploadIcons() {
      document.getElementById('videoUploadIcon').innerHTML = getIcon('video');
      document.getElementById('thumbnailUploadIcon').innerHTML = getIcon('image');
      document.getElementById('uploadIcon').innerHTML = getIcon('upload');
    }

    function setupRichTextEditor() {
      quillEditor = new Quill('#videoDescriptionEditor', {
        theme: 'snow',
        placeholder: '',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            ['link'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['clean']
          ]
        }
      });

      // Character counter
      quillEditor.on('text-change', function() {
        const text = quillEditor.getText();
        const length = text.trim().length;
        document.getElementById('descCharCount').textContent = Math.min(length, 500);

        // Limit to 500 characters
        if (length > 500) {
          quillEditor.deleteText(500, length);
        }
      });
    }

    let customTags = [];

    function setupUploadHandlers() {
      const videoFile = document.getElementById('videoFile');
      const videoUploadArea = document.getElementById('videoUploadArea');
      const uploadForm = document.getElementById('uploadForm');

      // Custom tags handler
      setupCustomTags();

      // Click to upload
      videoUploadArea.addEventListener('click', () => videoFile.click());

      // Drag and drop
      videoUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        videoUploadArea.classList.add('active');
      });

      videoUploadArea.addEventListener('dragleave', () => {
        videoUploadArea.classList.remove('active');
      });

      videoUploadArea.addEventListener('drop', async (e) => {
        e.preventDefault();
        videoUploadArea.classList.remove('active');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('video/')) {
          await handleVideoUpload(file);
        }
      });

      // File input change
      videoFile.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          await handleVideoUpload(file);
        }
      });

      // Custom thumbnail upload
      document.getElementById('customThumbnailInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          uploadState.customThumbnail = file;
          showNotification('Custom thumbnail selected', 'success');
        }
      });

      // Character counter for title
      document.getElementById('videoTitle').addEventListener('input', (e) => {
        document.getElementById('titleCharCount').textContent = e.target.value.length;
      });

      // Form submit
      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleFormSubmit();
      });
    }

    async function handleVideoUpload(file) {
      uploadState.originalFile = file;
      uploadState.processedFile = file;

      // Enable submit button
      const submitBtn = document.getElementById('uploadSubmitBtn');
      submitBtn.disabled = false;
      submitBtn.style.opacity = '1';
      submitBtn.style.cursor = 'pointer';
      submitBtn.nextElementSibling.textContent = 'Ready to upload!';

      // Show video preview section
      document.getElementById('videoPreviewSection').classList.remove('hidden');

      // Display file info
      const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
      document.getElementById('originalSize').textContent = `${fileSizeMB} MB`;

      // Load video preview
      const videoPreview = document.getElementById('videoPreview');
      videoPreview.src = URL.createObjectURL(file);

      // Extract metadata
      await new Promise((resolve, reject) => {
        videoPreview.onloadedmetadata = async () => {
          uploadState.metadata.duration = videoPreview.duration;
          uploadState.metadata.width = videoPreview.videoWidth;
          uploadState.metadata.height = videoPreview.videoHeight;

          // Display metadata
          document.getElementById('videoDuration').textContent = formatTime(videoPreview.duration);
          document.getElementById('videoResolution').textContent = `${videoPreview.videoWidth}x${videoPreview.videoHeight}`;

          // Auto-detect quality
          const quality = detectQuality(videoPreview.videoWidth, videoPreview.videoHeight);
          uploadState.metadata.quality = quality;
          document.getElementById('detectedQuality').textContent = quality;

          // Check if compression needed
          const needsCompression = file.size > 100 * 1024 * 1024; // > 100MB
          uploadState.metadata.needsCompression = needsCompression;

          if (needsCompression) {
            // Auto-compress
            await autoCompressVideo(file);
          } else {
            document.getElementById('finalSize').textContent = `${fileSizeMB} MB`;
          }

          // Generate thumbnails
          await generateThumbnails();

          // Show remaining sections
          document.getElementById('thumbnailSection').classList.remove('hidden');
          document.getElementById('detailsSection').classList.remove('hidden');
          document.getElementById('submitSection').classList.remove('hidden');

          resolve();
        };

        videoPreview.onerror = reject;
      });
    }

    function detectQuality(width, height) {
      if (width >= 3840 || height >= 2160) return '4K Ultra HD';
      if (width >= 2560 || height >= 1440) return '2K QHD';
      if (width >= 1920 || height >= 1080) return 'Full HD 1080p';
      if (width >= 1280 || height >= 720) return 'HD 720p';
      if (width >= 854 || height >= 480) return 'SD 480p';
      return 'Low Quality';
    }

    async function autoCompressVideo(file) {
      try {
        document.getElementById('compressionStatus').classList.remove('hidden');
        showNotification('Auto-compressing video for optimal quality...', 'info');

        // Load FFmpeg if not loaded
        if (!uploadState.ffmpegLoaded) {
          uploadState.ffmpeg = new FFmpeg.FFmpeg();

          uploadState.ffmpeg.on('log', ({ message }) => {
            console.log('[FFmpeg]', message);
          });

          uploadState.ffmpeg.on('progress', ({ progress }) => {
            const percent = Math.round(progress * 100);
            document.getElementById('compressionStatus').innerHTML =
              `<strong>Compressing: ${percent}%</strong> Optimizing your video for web playback`;
          });

          const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd';
          const { toBlobURL } = FFmpegUtil;
          await uploadState.ffmpeg.load({
            coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
            wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm')
          });

          uploadState.ffmpegLoaded = true;
        }

        const ffmpeg = uploadState.ffmpeg;

        // Write input file
        await ffmpeg.writeFile('input.mp4', await fetchFile(file));

        // Compress with medium quality
        await ffmpeg.exec([
          '-i', 'input.mp4',
          '-vcodec', 'libx264',
          '-crf', '23',
          '-preset', 'medium',
          '-vf', 'scale=-2:720', // Scale to 720p
          '-acodec', 'aac',
          'output.mp4'
        ]);

        // Read output
        const data = await ffmpeg.readFile('output.mp4');
        const blob = new Blob([data.buffer], { type: 'video/mp4' });
        uploadState.processedFile = new File([blob], 'compressed_' + file.name, { type: 'video/mp4' });

        // Update final size
        const finalSizeMB = (uploadState.processedFile.size / (1024 * 1024)).toFixed(2);
        document.getElementById('finalSize').textContent = `${finalSizeMB} MB`;
        document.getElementById('finalSize').style.color = '#10b981'; // Green for compressed

        // Clean up
        await ffmpeg.deleteFile('input.mp4');
        await ffmpeg.deleteFile('output.mp4');

        document.getElementById('compressionStatus').innerHTML =
          `<strong>✓ Compressed!</strong> Reduced size by ${((1 - uploadState.processedFile.size / file.size) * 100).toFixed(0)}%`;

        showNotification('Video compressed successfully!', 'success');
      } catch (error) {
        console.error('Compression error:', error);
        document.getElementById('compressionStatus').classList.add('hidden');
        showNotification('Compression failed, uploading original video', 'warning');
        uploadState.processedFile = file;
        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        document.getElementById('finalSize').textContent = `${fileSizeMB} MB`;
      }
    }

    async function generateThumbnails() {
      const positions = [0.1, 0.3, 0.5, 0.7, 0.9];
      const thumbnailsContainer = document.getElementById('thumbnailsGrid');
      thumbnailsContainer.innerHTML = '';

      const video = document.createElement('video');
      video.src = URL.createObjectURL(uploadState.originalFile);
      video.muted = true;

      await new Promise(resolve => {
        video.onloadedmetadata = resolve;
      });

      for (let i = 0; i < positions.length; i++) {
        const time = positions[i] * uploadState.metadata.duration;
        video.currentTime = time;

        await new Promise(resolve => {
          video.onseeked = () => {
            const canvas = document.createElement('canvas');
            canvas.width = 320;
            canvas.height = 180;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, 320, 180);

            canvas.toBlob(blob => {
              uploadState.thumbnails.push(blob);

              const img = document.createElement('img');
              img.src = URL.createObjectURL(blob);
              img.className = 'thumbnail-option';
              img.dataset.index = i;
              img.addEventListener('click', () => selectThumbnail(i));
              thumbnailsContainer.appendChild(img);

              resolve();
            }, 'image/jpeg', 0.9);
          };
        });
      }

      // Auto-select middle thumbnail
      selectThumbnail(2);
    }

    function selectThumbnail(index) {
      uploadState.selectedThumbnail = uploadState.thumbnails[index];

      document.querySelectorAll('.thumbnail-option').forEach((img, i) => {
        img.classList.toggle('selected', i === index);
      });
    }

    function setupCustomTags() {
      const customTagInput = document.getElementById('customTagInput');
      const addCustomTagBtn = document.getElementById('addCustomTagBtn');
      const customTagsList = document.getElementById('customTagsList');

      function addCustomTag() {
        const tagValue = customTagInput.value.trim();
        if (!tagValue) return;

        // Convert to snake_case for consistency
        const tagKey = tagValue.toLowerCase().replace(/\s+/g, '_');

        // Check if tag already exists
        if (customTags.includes(tagKey)) {
          showNotification('Tag already added', 'warning');
          return;
        }

        // Add to array
        customTags.push(tagKey);

        // Create tag chip
        const tagChip = document.createElement('div');
        tagChip.className = 'custom-tag-chip';
        tagChip.innerHTML = `
          <span>${tagValue}</span>
          <button type="button" class="remove-tag-btn" data-tag="${tagKey}">×</button>
        `;
        customTagsList.appendChild(tagChip);

        // Add remove listener
        tagChip.querySelector('.remove-tag-btn').addEventListener('click', function() {
          const tagToRemove = this.dataset.tag;
          customTags = customTags.filter(t => t !== tagToRemove);
          tagChip.remove();
        });

        // Clear input
        customTagInput.value = '';
      }

      addCustomTagBtn.addEventListener('click', addCustomTag);
      customTagInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addCustomTag();
        }
      });
    }

    async function handleFormSubmit() {
      const title = document.getElementById('videoTitle').value.trim();
      const description = quillEditor.root.innerHTML;
      const selectedTags = Array.from(document.querySelectorAll('input[name="tags"]:checked'))
        .map(cb => cb.value);

      // Combine predefined and custom tags
      const allTags = [...selectedTags, ...customTags];

      // Validation
      if (!title) {
        showNotification('Please enter a video title', 'error');
        return;
      }

      if (allTags.length === 0) {
        showNotification('Please select or add at least one tag', 'error');
        return;
      }

      try {
        // Show progress
        document.getElementById('uploadProgressSection').classList.remove('hidden');
        document.getElementById('submitSection').classList.add('hidden');

        // Upload to Cloudflare Stream
        document.getElementById('uploadStatusText').textContent = 'Uploading to Cloudflare Stream...';

        const streamData = await uploadToCloudflareStream(
          uploadState.processedFile,
          { title },
          (progress) => {
            document.getElementById('uploadProgressBar').style.width = `${progress}%`;
            document.getElementById('uploadProgressText').textContent = `${Math.round(progress)}%`;
          }
        );

        // Wait for processing
        document.getElementById('uploadStatusText').textContent = 'Processing video...';
        await waitForProcessing(streamData.uid);

        // Upload thumbnail
        document.getElementById('uploadStatusText').textContent = 'Uploading thumbnail...';
        const thumbnail = uploadState.customThumbnail || uploadState.selectedThumbnail;

        const user = await getCurrentUser();
        if (!user) throw new Error('Not authenticated');

        const thumbnailFileName = `${user.id}/${Date.now()}_thumb.jpg`;
        const { data: thumbnailData, error: thumbnailError } = await supabaseClient.storage
          .from('thumbnails')
          .upload(thumbnailFileName, thumbnail);

        if (thumbnailError) throw thumbnailError;

        const { data: { publicUrl: thumbnailUrl } } = supabaseClient.storage
          .from('thumbnails')
          .getPublicUrl(thumbnailFileName);

        // Save to database
        document.getElementById('uploadStatusText').textContent = 'Saving video data...';

        const { data, error } = await supabaseClient
          .from('videos')
          .insert([{
            user_id: user.id,
            title,
            description,
            tags: allTags.join(','),
            stream_id: streamData.uid,
            stream_url: `https://videodelivery.net/${streamData.uid}/manifest/video.m3u8`,
            thumbnail_url: thumbnailUrl,
            duration: Math.round(uploadState.metadata.duration),
            resolution: `${uploadState.metadata.width}x${uploadState.metadata.height}`,
            views_count: 0
          }])
          .select()
          .single();

        if (error) throw error;

        showNotification('Video uploaded successfully!', 'success');

        // Redirect to watch page
        setTimeout(() => {
          window.location.href = `watch.html?v=${data.id}`;
        }, 2000);

      } catch (error) {
        console.error('Upload error:', error);
        showNotification('Error uploading video: ' + error.message, 'error');
        document.getElementById('submitSection').classList.remove('hidden');
        document.getElementById('uploadProgressSection').classList.add('hidden');
      }
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    async function fetchFile(file) {
      return new Uint8Array(await file.arrayBuffer());
    }
  </script>

  <!-- Adsterra Scripts -->
  <script async="async" data-cfasync="false" src="https://pl28394065.effectivegatecpm.com/ce630968429585fc33b1cd2e0f35d06a/invoke.js"></script>
  <div id="container-ce630968429585fc33b1cd2e0f35d06a"></div>
  <script src="https://pl28394078.effectivegatecpm.com/30/7d/66/307d667458334a8e0ab5a0293231b8b3.js"></script>
</body>
</html>
