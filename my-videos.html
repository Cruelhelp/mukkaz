<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://pl28394065.effectivegatecpm.com https://pl28394078.effectivegatecpm.com https://va.vercel-scripts.com https://cdn.growthbook.io; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data: https: blob:; media-src 'self' blob: https: https://videodelivery.net https://cloudflarestream.com; connect-src 'self' https://*.supabase.co https://cdn.jsdelivr.net https://api.cloudflare.com https://videodelivery.net https://embed.cloudflarestream.com https://vitals.vercel-insights.com https://cdn.growthbook.io; frame-src 'self' https://embed.cloudflarestream.com https://iframe.videodelivery.net; worker-src 'self' blob:; child-src 'self' blob:; object-src 'none'; base-uri 'self';">
  <title>My Videos - Mukkaz</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="config.local.js" onerror="console.warn('config.local.js not found - using defaults')"></script>
  <script src="config.js"></script>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="youtube-redesign.css">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="age-gate.js"></script>
  <script src="components.js"></script>
  <script src="analytics.js"></script>
  <script src="growthbook.js"></script>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-left">
      <button class="nav-icon hamburger-btn" id="hamburgerBtn">
        <span id="hamburgerIcon"></span>
      </button>
      <a href="index.html" class="logo">
        <img src="logo.png" alt="Mukkaz" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="navbar-center">
      <div class="search-container">
        <input
          type="text"
          class="search-input"
          id="searchInput"
          placeholder="Search videos..."
          autocomplete="off"
        >
        <button class="search-btn" id="searchBtn">
          <span id="searchIcon"></span>
        </button>
        <div class="search-suggestions hidden" id="searchSuggestions">
          <!-- Tag suggestions populated by JavaScript -->
        </div>
      </div>
    </div>

    <div class="navbar-right" id="navbarRight">
      <!-- Loading skeleton -->
      <div class="navbar-skeleton" id="navbarSkeleton">
        <div class="skeleton-nav-icon"></div>
        <div class="skeleton-nav-icon"></div>
        <div class="skeleton-avatar"></div>
      </div>
    </div>
  </nav>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <!-- Home, Trending & History Section -->
    <div class="sidebar-section">
      <a href="index.html" class="sidebar-item">
        <span id="homeIcon"></span>
        <span>Home</span>
      </a>
      <a href="index.html#trending" class="sidebar-item">
        <span id="trendingIcon"></span>
        <span>Trending</span>
      </a>
      <a href="history.html" class="sidebar-item">
        <span id="historyIcon"></span>
        <span>History</span>
      </a>
    </div>

    <!-- Subscriptions Section -->
    <div class="sidebar-section" id="subscriptionsSidebarSection">
      <div class="sidebar-section-header">
        <span id="subscriptionsIcon"></span>
        <span>Subscriptions</span>
      </div>
      <div id="subscriptionsList">
        <!-- Subscriptions loaded by JavaScript -->
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="history-page-container">
      <!-- Header -->
      <div class="history-header">
        <h1>My Videos</h1>
      </div>

      <!-- Two Column Layout -->
      <div class="history-layout">
        <!-- Main Video List -->
        <div class="history-main">
          <!-- Filter Chips -->
          <div class="history-filters">
            <button class="category-btn active" data-filter="all">All</button>
            <button class="category-btn" data-filter="public">Public</button>
            <button class="category-btn" data-filter="private">Private</button>
          </div>

          <!-- Video Items -->
          <div id="videosList">
            <!-- Loading skeleton -->
            <div class="history-skeleton" id="videosSkeleton">
              <div class="history-item-skeleton">
                <div class="skeleton-thumb-horizontal"></div>
                <div class="skeleton-info-horizontal">
                  <div class="skeleton-title-horizontal"></div>
                  <div class="skeleton-text-horizontal"></div>
                </div>
              </div>
              <div class="history-item-skeleton">
                <div class="skeleton-thumb-horizontal"></div>
                <div class="skeleton-info-horizontal">
                  <div class="skeleton-title-horizontal"></div>
                  <div class="skeleton-text-horizontal"></div>
                </div>
              </div>
              <div class="history-item-skeleton">
                <div class="skeleton-thumb-horizontal"></div>
                <div class="skeleton-info-horizontal">
                  <div class="skeleton-title-horizontal"></div>
                  <div class="skeleton-text-horizontal"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar Actions -->
        <div class="history-sidebar">
          <!-- Search Videos -->
          <div class="history-search-box">
            <span id="videoSearchIcon"></span>
            <input
              type="text"
              id="videoSearchInput"
              placeholder="Search my videos"
              class="history-search-input"
            >
          </div>

          <!-- Quick Stats -->
          <div class="history-info" style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <span>Total Videos:</span>
              <strong id="totalVideos">0</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <span>Total Views:</span>
              <strong id="totalViews">0</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Total Likes:</span>
              <strong id="totalLikes">0</strong>
            </div>
          </div>

          <!-- Actions -->
          <div class="history-actions">
            <a href="upload.html" class="history-action-btn">
              <span id="uploadIcon"></span>
              <span>Upload New Video</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Edit Video Modal -->
  <div class="modal-overlay hidden" id="editVideoModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Edit Video</h2>
        <button class="modal-close" id="closeEditModal">
          <span id="closeEditIcon"></span>
        </button>
      </div>

      <form class="auth-form" id="editVideoForm">
        <div class="form-group">
          <label class="form-label">Title</label>
          <input
            type="text"
            class="form-input"
            id="editVideoTitle"
            required
          >
        </div>

        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea
            class="form-input"
            id="editVideoDescription"
            rows="4"
          ></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Tags (Select all that apply)</label>
          <div class="tags-container" id="editVideoTags">
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="big_batty">
              <span>Big Batty</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="phat_pussy">
              <span>Phat Pussy</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="backshot">
              <span>Backshot</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="hood_gyal">
              <span>Hood Gyal</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="tight_pussy">
              <span>Tight Pussy</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="kingston">
              <span>Kingston</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="st_andrew">
              <span>St. Andrew</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="st_catherine">
              <span>St. Catherine</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="portmore">
              <span>Portmore</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="spanish_town">
              <span>Spanish Town</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="montego_bay">
              <span>Montego Bay</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="mandeville">
              <span>Mandeville</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="ocho_rios">
              <span>Ocho Rios</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="bumper">
              <span>Bumper</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="cocky">
              <span>Cocky</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="fuck">
              <span>Fuck</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="breed">
              <span>Breed</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="suck">
              <span>Suck</span>
            </label>
            <label class="tag-checkbox">
              <input type="checkbox" name="edit_tags" value="badman">
              <span>Badman</span>
            </label>
          </div>
        </div>

        <button type="submit" class="btn-primary">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="icons.js"></script>
  <script src="utils.js"></script>
  <script src="supabase.js"></script>
  <script src="app.js"></script>
  <script>
    let currentUser = null;
    let currentProfile = null;
    let allMyVideos = [];
    let currentFilter = 'all';

    document.addEventListener('DOMContentLoaded', async () => {
      await initializeApp();

      // Load icons
      document.getElementById('videoSearchIcon').innerHTML = getIcon('search');
      document.getElementById('uploadIcon').innerHTML = getIcon('upload');

      await loadMyVideos();
      setupEventListeners();
    });

    async function loadMyVideos() {
      currentUser = await getCurrentUser();
      const videosList = document.getElementById('videosList');
      const skeleton = document.getElementById('videosSkeleton');

      if (!currentUser) {
        window.location.href = 'index.html';
        return;
      }

      try {
        currentProfile = await getProfile(currentUser.id);
        const allVideos = await getVideos();
        allMyVideos = allVideos.filter(v => v.user_id === currentUser.id);

        skeleton.style.display = 'none';

        if (allMyVideos.length === 0) {
          videosList.innerHTML = `
            <div style="text-align: center; padding: 4rem 2rem; color: var(--text-secondary);">
              <p style="font-size: 18px; margin-bottom: 8px;">No Videos Yet</p>
              <p style="font-size: 14px;">You haven't uploaded any videos yet</p>
            </div>
          `;
          return;
        }

        updateStats(allMyVideos);
        displayVideos(allMyVideos);
      } catch (error) {
        console.error('Error loading videos:', error);
        skeleton.style.display = 'none';
        videosList.innerHTML = '<p class="secondary" style="padding: 2rem; text-align: center;">Error loading videos</p>';
      }
    }

    function displayVideos(videos) {
      const videosList = document.getElementById('videosList');

      if (videos.length === 0) {
        videosList.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            <p>No videos found</p>
          </div>
        `;
        return;
      }

      // Group by date
      const grouped = groupByDate(videos);

      let html = '';
      for (const [date, items] of Object.entries(grouped)) {
        html += `<div class="history-date-section">
          <div class="history-date-header">${date}</div>`;

        items.forEach(video => {
          const profile = video.profiles || currentProfile;
          const thumbnailUrl = video.thumbnail_url || 'https://via.placeholder.com/280x158?text=No+Thumbnail';

          html += `
            <div class="history-item" data-video-id="${video.id}">
              <a href="watch.html?v=${video.id}" class="history-thumbnail">
                <img src="${thumbnailUrl}" alt="${escapeHtml(video.title)}">
                ${video.duration ? `<div class="video-duration">${video.duration}</div>` : ''}
              </a>
              <div class="history-info">
                <a href="watch.html?v=${video.id}" class="history-title">${escapeHtml(video.title)}</a>
                <div class="history-meta">
                  <span class="history-views">${formatNumber(video.views_count || 0)} views</span>
                  <span>•</span>
                  <span class="history-views">${formatNumber(video.likes_count || 0)} likes</span>
                  <span>•</span>
                  <span class="history-date">${timeSince(new Date(video.created_at))} ago</span>
                </div>
                ${video.description ? `<div class="history-description">${escapeHtml(video.description.substring(0, 100))}...</div>` : ''}
              </div>
              <div class="video-item-actions">
                <button class="history-action-icon" onclick="editVideo('${video.id}')" title="Edit">
                  ${getIcon('edit')}
                </button>
                <button class="history-action-icon" onclick="shareVideo('${video.id}')" title="Share">
                  ${getIcon('share')}
                </button>
                <button class="history-action-icon danger" onclick="confirmDeleteVideo('${video.id}')" title="Delete">
                  ${getIcon('delete')}
                </button>
              </div>
            </div>
          `;
        });

        html += '</div>';
      }

      videosList.innerHTML = html;
    }

    function groupByDate(videos) {
      const groups = {};
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      videos.forEach(video => {
        const videoDate = new Date(video.created_at);
        const videoDay = new Date(videoDate.getFullYear(), videoDate.getMonth(), videoDate.getDate());

        let label;
        if (videoDay.getTime() === today.getTime()) {
          label = 'Today';
        } else if (videoDay.getTime() === yesterday.getTime()) {
          label = 'Yesterday';
        } else {
          label = videoDay.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }

        if (!groups[label]) groups[label] = [];
        groups[label].push(video);
      });

      return groups;
    }

    function updateStats(videos) {
      const totalVideos = videos.length;
      const totalViews = videos.reduce((sum, v) => sum + (v.views_count || 0), 0);
      const totalLikes = videos.reduce((sum, v) => sum + (v.likes_count || 0), 0);

      document.getElementById('totalVideos').textContent = formatNumber(totalVideos);
      document.getElementById('totalViews').textContent = formatNumber(totalViews);
      document.getElementById('totalLikes').textContent = formatNumber(totalLikes);
    }

    function setupEventListeners() {
      // Filter buttons
      document.querySelectorAll('.history-filters .category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.history-filters .category-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;

          let filtered = allMyVideos;
          if (currentFilter === 'public') {
            filtered = allMyVideos.filter(v => !v.is_private);
          } else if (currentFilter === 'private') {
            filtered = allMyVideos.filter(v => v.is_private);
          }

          displayVideos(filtered);
        });
      });

      // Search
      const searchInput = document.getElementById('videoSearchInput');
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        if (query) {
          const filtered = allMyVideos.filter(v =>
            v.title.toLowerCase().includes(query) ||
            (v.description && v.description.toLowerCase().includes(query)) ||
            (v.tags && v.tags.toLowerCase().includes(query))
          );
          displayVideos(filtered);
        } else {
          displayVideos(allMyVideos);
        }
      });
    }

    function editVideo(videoId) {
      window.location.href = `video-editor.html?v=${videoId}`;
    }

    async function shareVideo(videoId) {
      const url = `${window.location.origin}/watch.html?v=${videoId}`;
      try {
        await navigator.clipboard.writeText(url);
        showNotification('Link copied to clipboard', 'success');
      } catch (error) {
        const tempInput = document.createElement('input');
        tempInput.value = url;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showNotification('Link copied to clipboard', 'success');
      }
    }

    function confirmDeleteVideo(videoId) {
      if (confirm('Are you sure you want to delete this video? This action cannot be undone.')) {
        deleteVideo(videoId);
      }
    }

    async function deleteVideo(videoId) {
      try {
        showNotification('Deleting video...', 'info');

        // Delete all related records first to avoid foreign key constraints

        // Delete video votes
        await supabaseClient
          .from('video_votes')
          .delete()
          .eq('video_id', videoId);

        // Delete comments
        await supabaseClient
          .from('comments')
          .delete()
          .eq('video_id', videoId);

        // Delete watch history
        await supabaseClient
          .from('watch_history')
          .delete()
          .eq('video_id', videoId);

        // Delete bookmarks
        await supabaseClient
          .from('bookmarks')
          .delete()
          .eq('video_id', videoId);

        // Delete notifications
        await supabaseClient
          .from('notifications')
          .delete()
          .eq('video_id', videoId);

        // Finally delete the video
        const { error } = await supabaseClient
          .from('videos')
          .delete()
          .eq('id', videoId);

        if (error) throw error;

        showNotification('Video deleted successfully', 'success');

        // Remove from local array and refresh display
        allMyVideos = allMyVideos.filter(v => v.id !== videoId);
        displayVideos(allMyVideos);
        updateStats(allMyVideos);
      } catch (error) {
        console.error('Error deleting video:', error);
        showNotification('Error deleting video: ' + error.message, 'error');
      }
    }

    // Global functions
    window.editVideo = editVideo;
    window.shareVideo = shareVideo;
    window.confirmDeleteVideo = confirmDeleteVideo;

    // Edit video modal
    let editingVideoId = null;

    function openEditModal(videoId, title, description, tags) {
      editingVideoId = videoId;

      document.getElementById('editVideoTitle').value = title;
      document.getElementById('editVideoDescription').value = description;

      // Uncheck all tags first
      document.querySelectorAll('input[name="edit_tags"]').forEach(checkbox => {
        checkbox.checked = false;
      });

      // Check tags that are selected
      if (tags) {
        const tagArray = tags.split(',').map(t => t.trim()).filter(t => t);
        tagArray.forEach(tag => {
          const checkbox = document.querySelector(`input[name="edit_tags"][value="${tag}"]`);
          if (checkbox) checkbox.checked = true;
        });
      }

      document.getElementById('editVideoModal').classList.remove('hidden');
    }

    // Close edit modal
    document.getElementById('closeEditModal').addEventListener('click', () => {
      document.getElementById('editVideoModal').classList.add('hidden');
      editingVideoId = null;
    });

    // Handle edit form submission
    document.getElementById('editVideoForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!editingVideoId) return;

      const title = document.getElementById('editVideoTitle').value.trim();
      const description = document.getElementById('editVideoDescription').value.trim();

      // Get selected tags
      const selectedTags = Array.from(document.querySelectorAll('input[name="edit_tags"]:checked'))
        .map(cb => cb.value);

      try {
        showNotification('Updating video...', 'info');

        await updateVideo(editingVideoId, {
          title,
          description,
          tags: selectedTags
        });

        showNotification('Video updated successfully', 'success');
        document.getElementById('editVideoModal').classList.add('hidden');
        editingVideoId = null;

        // Reload videos
        await loadUserVideos();
      } catch (error) {
        console.error('Error updating video:', error);
        showNotification('Error updating video', 'error');
      }
    });

    // Add close edit icon
    document.getElementById('closeEditIcon').innerHTML = getIcon('close');
  </script>

  <!-- Ads removed -->
</body>
</html>
